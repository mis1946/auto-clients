/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package org.rmj.auto.service.base;

import java.math.BigDecimal;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.sql.rowset.CachedRowSet;
import javax.sql.rowset.RowSetFactory;
import javax.sql.rowset.RowSetProvider;
import org.json.simple.JSONObject;
import org.rmj.appdriver.GRider;
import org.rmj.appdriver.MiscUtil;
import org.rmj.appdriver.SQLUtil;
import org.rmj.appdriver.StringUtil;
import org.rmj.appdriver.agentfx.ui.showFXDialog;
import org.rmj.appdriver.callback.MasterCallback;
import org.rmj.appdriver.constants.EditMode;
import org.rmj.appdriver.constants.RecordStatus;
import org.rmj.auto.clients.base.CompareRows;
import org.rmj.auto.parameters.CancellationMaster;

/**
 *
 * @author Arsiela
 */
public class JobOrderMaster {
    private final String MASTER_TABLE = "diagnostic_master";
    private final String JOLABOR_TABLE = "diagnostic_labor";
    private final String JOPARTS_TABLE = "diagnostic_parts";
    private final String DEFAULT_DATE = "1900-01-01";
    
    private GRider poGRider;
    private String psBranchCd;
    private boolean pbWithParent;
    private MasterCallback poCallback;
    private CancellationMaster oTransCancel;
    
    private int pnEditMode;
    private boolean pbWithUI;
    private String psMessage;
    private Integer pnDeletedLaborRow[];
    private Integer pnDeletedPartsRow[];
    
    private CachedRowSet poMaster;
    private CachedRowSet poMasterOrig;
    private CachedRowSet poLabor;
    private CachedRowSet poLaborOrig;
    private CachedRowSet poParts;
    private CachedRowSet poPartsOrig;
    
    List<Integer> deletedLaborRows = new ArrayList<>();
    List<Integer> deletedPartsRows = new ArrayList<>();
    
    public JobOrderMaster(GRider foGRider, String fsBranchCd, boolean fbWithParent){            
        poGRider = foGRider;
        psBranchCd = fsBranchCd;
        pbWithParent = fbWithParent;                       
    }  
    
    public int getEditMode(){
        return pnEditMode;
    }
    
    public String getMessage(){
         return psMessage;         
    }
    
    public void setWithUI(boolean fbValue) {
        pbWithUI = fbValue;
    }
    
    public void setCallback(MasterCallback foValue){
        poCallback = foValue;
    }
    
    //FOR TESTING
    public int getItemCount() throws SQLException{
        if (poMaster != null){
            poMaster.last();
            return poMaster.getRow();
        }else{
            return 0;
        }
    }
    
    public void setMaster(int fnIndex, Object foValue) throws SQLException{
        poMaster.first();
        
        switch (fnIndex){     
            case 1:    //sTransNox 
            case 3:    //sDSNoxxxx 
            case 4:    //sSerialID 
            case 5:    //sClientID 
            case 6:    //sWorkCtgy 
            case 7:    //sJobTypex 
            case 8:    //sLaborTyp 
            case 10:   //sEmployID 
            case 11:   //sRemarksx 
            case 12:   //cPaySrcex 
            case 13:   //sSourceNo 
            case 14:   //sSourceCD 
            case 16:   //sInsurnce 
            case 17:   //cCompUnit 
            case 18:   //sActvtyID 
            case 24:   //cPrintedx 
            case 25:   //cTranStat 
            case 26:   //sEntryByx 
            case 27:   //dEntryDte 
            case 28:   //sModified  
            case 30:   //cTrStatus
            case 31:   //sCompnyNm /*CUTOMER NAME*/
            case 32:   //sAddressx /*CUSTOMER ADDRESS*/
            case 33:   //sCoOwnrNm /*CO-OWNER NAME*/
            case 34:   //sCoBuyrNm /*CO-BUYER NAME*/
            case 35:   //sDescript
            case 36:   //sCSNoxxxx
            case 37:   //sPlateNox
            case 38:   //sFrameNox
            case 39:   //sEngineNo
            case 40:   //sEmployNm /*SE OR SA NAME*/
            case 41:   //sBranchCD /*VSP BRANCH CODE*/ 
                poMaster.updateObject(fnIndex, (String) foValue);
                poMaster.updateRow();
                if (poCallback != null) poCallback.onSuccess(fnIndex, getMaster(fnIndex));
                break;
            /*dTimeStmp*/
            case 2:    //dTransact 
            case 15:   //dPromised
            case 29:   //dModified
                if (foValue instanceof Date){
                    poMaster.updateObject(fnIndex, foValue);
                } else {
                    poMaster.updateObject(fnIndex, SQLUtil.toDate(DEFAULT_DATE, SQLUtil.FORMAT_SHORT_DATE));
                }
                poMaster.updateRow();
                if (poCallback != null) poCallback.onSuccess(fnIndex, getMaster(fnIndex));  
                break; 
            case 9:    //nKMReadng     
                if (foValue instanceof Integer)
                    poMaster.updateInt(fnIndex, (int) foValue);
                else 
                    poMaster.updateInt(fnIndex, 0);
                
                poMaster.updateRow();
                if (poCallback != null) poCallback.onSuccess(fnIndex, getMaster(fnIndex));               
                break;
            case 19:   //nLaborAmt 
            case 20:   //nPartsAmt 
            case 21:   //nTranAmtx 
            case 22:   //nRcvryAmt 
            case 23:   //nPartFeex 
                poMaster.updateDouble(fnIndex, 0.00);
                if (StringUtil.isNumeric(String.valueOf(foValue))) {
                    //poMaster.updateDouble(fnIndex,(Double) foValue);
                    poMaster.updateObject(fnIndex,foValue);
                }
                
                poMaster.updateRow();   
                break;
        }
    }
    
    public void setMaster(String fsIndex, Object foValue) throws SQLException{
        setMaster(MiscUtil.getColumnIndex(poMaster, fsIndex), foValue);
    }
    
    public Object getMaster(String fsIndex) throws SQLException{
        return getMaster(MiscUtil.getColumnIndex(poMaster, fsIndex));
    }
    
    public Object getMaster(int fnIndex) throws SQLException{
        poMaster.first();
        return poMaster.getObject(fnIndex);
    }
    
    public Object getDetail(int fnRow, int fnIndex) throws SQLException{
        if (fnIndex == 0) return null;
        
        poMaster.absolute(fnRow);
        return poMaster.getObject(fnIndex);
    }
    
    public Object getDetail(int fnRow, String fsIndex) throws SQLException{
        return getDetail(fnRow, MiscUtil.getColumnIndex(poMaster, fsIndex));
    }
    
    /**
    * Initializes the master data for adding a new entry.
    */
    public boolean NewRecord(){
        if (poGRider == null){
            psMessage = "Application driver is not set.";
            return false;
        }
        
        if (psBranchCd.isEmpty()) psBranchCd = poGRider.getBranchCode();
        
        try {
            String lsSQL = getSQ_Master() + " WHERE 0=1";
            System.out.println(lsSQL);
            ResultSet loRS = poGRider.executeQuery(lsSQL);
            
            RowSetFactory factory = RowSetProvider.newFactory();
            poMaster = factory.createCachedRowSet();
            poMaster.populate(loRS);
            MiscUtil.close(loRS);
            
            poMaster.last();
            poMaster.moveToInsertRow();
            
            MiscUtil.initRowSet(poMaster);       
            poMaster.updateString("cTranStat", RecordStatus.ACTIVE);   //0 Cancelled, 1 Active
            poMaster.updateObject("dTransact", poGRider.getServerDate());   
            poMaster.updateObject("dPromised", poGRider.getServerDate());   
            poMaster.updateString("sWorkCtgy", "0"); //mech, body
            poMaster.updateString("sJobTypex", "0"); //new, bjob, jcon
            poMaster.updateString("sLaborTyp", "0"); //gr, pm, pmgr, body, pdi (if sales)
            poMaster.updateString("cPaySrcex", "0"); 
            //poMaster.updateString("cCompUnit", "0");  is company unit? 0 or 1; move to cPaySrcex?
            poMaster.updateString("cPrintedx", "0");  //is printed? 0 or 1
            
            //Add Initial Value for double datatype
            poMaster.updateDouble("nKMReadng", 0.00); 
            poMaster.updateDouble("nLaborAmt", 0.00); 
            poMaster.updateDouble("nPartsAmt", 0.00); 
            poMaster.updateDouble("nTranAmtx", 0.00); 
            poMaster.updateDouble("nRcvryAmt", 0.00); 
            poMaster.updateDouble("nPartFeex", 0.00); 
            
            poMaster.insertRow();
            poMaster.moveToCurrentRow(); 
            
        } catch (SQLException e) {
            psMessage = e.getMessage();
            return false;
        }
        
        pnEditMode = EditMode.ADDNEW;
        return true;
    }
    
    /**
     *  Searches for a Job Order record.
     * 
    */
    public boolean searchRecord() throws SQLException{
        String lsSQL = getSQ_Master() + " WHERE a.sTransNox LIKE '%' " + 
                       " GROUP BY a.sTransNox " ;
        
        JSONObject loJSON = null;
        if (pbWithUI){
            loJSON = showFXDialog.jsonSearch(poGRider
                                                    , lsSQL
                                                    , "%"
                                                    , "Job Order No»Customer»CS No»Plate No»Cancelled»"
                                                    , "sDSNoxxxx»sCompnyNm»sCSNoxxxx»sPlateNox»cTrStatus"
                                                    , "a.sDSNoxxxx»c.sCompnyNm»d.sCSNoxxxx»e.sPlateNox"
                                                    , 0);
            if (loJSON == null){
                psMessage = "No record found/selected.";
                return false;
            } else {
                if (OpenRecord((String) loJSON.get("sTransNox")) ){
                    
                }else {
                    psMessage = "No record found/selected.";
                    return false;
                }
            }
        }
        return true;
    }
    
    /**
     * Opens a record with the specified value.
     * @param fsValue the value used to open the record
        * 
    */
    public boolean OpenRecord(String fsValue){
        try {
            String lsSQL = getSQ_Master() + " WHERE a.sTransNox = " + SQLUtil.toSQL(fsValue); 
            ResultSet loRS = poGRider.executeQuery(lsSQL);
            
            System.out.println(lsSQL);
            if (MiscUtil.RecordCount(loRS) <= 0){
                psMessage = "No record found.";
                MiscUtil.close(loRS);        
                return false;
            }
            
            RowSetFactory factory = RowSetProvider.newFactory();
            poMaster = factory.createCachedRowSet();
            poMaster.populate(loRS);
            MiscUtil.close(loRS);

        } catch (SQLException e) {
            psMessage = e.getMessage();
            return false;
        }
        
        pnEditMode = EditMode.READY;
        return true;
    }    
    
    /**
     * Prepares to update a record in the data.
     * This method creates copies of the original data to be updated and sets the edit mode to UPDATE.
     * 
    */
    public boolean UpdateRecord(){
        try {
            if (poMaster != null){
                poMasterOrig = (CachedRowSet) poMaster.createCopy();
            }
            
            if (poLabor != null){
                poLaborOrig = (CachedRowSet) poLabor.createCopy();
                deletedLaborRows.clear();
            }
            if (poParts != null){
                poPartsOrig = (CachedRowSet) poParts.createCopy();
                deletedPartsRows.clear();
            }
        } catch (SQLException ex) {
            Logger.getLogger(JobOrderMaster.class.getName()).log(Level.SEVERE, null, ex);
        }
        pnEditMode = EditMode.UPDATE;
        return true;        
    }
    
    /**
     * Saves a record to the database.
     * This method is responsible for adding a new record or updating an existing one based on the edit mode. It performs data validation and handles database transactions.
     * 
    */
    public boolean SaveRecord(){
        if (!(pnEditMode == EditMode.ADDNEW || pnEditMode == EditMode.UPDATE)){
            psMessage = "Invalid update mode detected.";
            return false;
        }
        
        try {
            int lnCtr = 1;
            String lsSQL = "";
            String lsTransNox = "";
            String lsDSNoxxxx = "";
            String lsgetBranchCd = "";
            
            if (pnEditMode == EditMode.ADDNEW){ //add
                lsDSNoxxxx = MiscUtil.getNextCode(MASTER_TABLE, "sDSNoxxxx", false, poGRider.getConnection(), psBranchCd);
                setMaster("sDSNoxxxx", lsDSNoxxxx);
            }
            //if (!isEntryOK()) return false;
            
            if (((String)getMaster("sWorkCtgy")).equals("jobo")){
                lsgetBranchCd = (String) getMaster("sBranchCD");
                if (psBranchCd.equals(lsgetBranchCd)){
                    lsgetBranchCd = "";
                }
            } else {
                lsgetBranchCd = "";
            }
            
            if (!pbWithParent) poGRider.beginTrans();
            if (pnEditMode == EditMode.ADDNEW){ //add
                /*JO MASTER*/
                lsTransNox = MiscUtil.getNextCode(MASTER_TABLE, "sTransNox", true, poGRider.getConnection(), psBranchCd);
                poMaster.updateString("sTransNox",lsTransNox); 
                poMaster.updateString("sEntryByx", poGRider.getUserID());
                poMaster.updateObject("dEntryDte", (Date) poGRider.getServerDate());
                poMaster.updateString("sModified", poGRider.getUserID());
                poMaster.updateObject("dModified", (Date) poGRider.getServerDate());
                poMaster.updateRow();    
                
                lsSQL = MiscUtil.rowset2SQL(poMaster, MASTER_TABLE, "sCompnyNm»sAddressx»sDescript»sCSNoxxxx»sPlateNox»sFrameNox»sEngineNo»cTrStatus»sCoOwnrNm»sCoBuyrNm»sEmployNm»sBranchCD");
                
                if (lsSQL.isEmpty()){
                    psMessage = "No record to update in jo master.";
                    return false;
                }
                if (poGRider.executeQuery(lsSQL, MASTER_TABLE, psBranchCd, lsgetBranchCd) <= 0){
                    psMessage = "ADD JO MASTER: " + poGRider.getErrMsg();
                    if (!pbWithParent) poGRider.rollbackTrans();
                    return false;
                }
                
                /*JO LABOR*/
                lsSQL = "";
                lnCtr = 1;
//                if (getLaborCount() > 0){
//                    poLabor.beforeFirst();                
//                    while (poLabor.next()){  
//                        poLabor.updateObject("sTransNox", lsTransNox); 
//                        poLabor.updateObject("nEntryNox", lnCtr);
//                        poLabor.updateString("cAddtlxxx", "0");
//                        poLabor.updateRow();
//
//                        lsSQL = MiscUtil.rowset2SQL(poLabor, LABOR_TABLE, "");
//                        if (lsSQL.isEmpty()){
//                            psMessage = "No record to update in vsp labor.";
//                            return false;
//                        }
//                        if (poGRider.executeQuery(lsSQL, LABOR_TABLE, psBranchCd, lsgetBranchCd) <= 0){
//                            if (!pbWithParent) poGRider.rollbackTrans();
//                            psMessage = "ADD VSP LABOR: " + poGRider.getMessage() + " ; " + poGRider.getErrMsg();
//                            return false;
//                        }
//                        lnCtr++;
//                    }
//                }
                
                /*JO PARTS*/
                lsSQL = "";
                lnCtr = 1;
//                if (getPartsCount() > 0){
//                    poParts.beforeFirst();                
//                    while (poParts.next()){  
//                        poParts.updateObject("sTransNox", lsTransNox); 
//                        poParts.updateObject("nEntryNox", lnCtr);
//                        poParts.updateRow();
//
//                        lsSQL = MiscUtil.rowset2SQL(poParts, PARTS_TABLE, "sBarCodex»sJobNoxxx");
//                        if (lsSQL.isEmpty()){
//                            psMessage = "No record to update in vsp parts.";
//                            return false;
//                        }
//                        if (poGRider.executeQuery(lsSQL, PARTS_TABLE, psBranchCd, lsgetBranchCd) <= 0){
//                            if (!pbWithParent) poGRider.rollbackTrans();
//                            psMessage = "ADD JO PARTS: " + poGRider.getMessage() + " ; " + poGRider.getErrMsg();
//                            return false;
//                        }
//                        lnCtr++;
//                    }
//                }
            
            } else { //update  
                boolean lbisModified = false;
                if (!CompareRows.isRowEqual(poMaster, poMasterOrig,1)) {
                    lbisModified = true;
                }
                if(lbisModified){
                    /*VSP MASTER*/
                    poMaster.updateString("sModified", poGRider.getUserID());
                    poMaster.updateObject("dModified", (Date) poGRider.getServerDate());
                    poMaster.updateRow();
                    lsSQL = MiscUtil.rowset2SQL(poMaster, 
                                                MASTER_TABLE, 
                                                "sCompnyNm»sAddressx»sDescript»sCSNoxxxx»sPlateNox»sFrameNox»sEngineNo»cTrStatus»sCoOwnrNm»sCoBuyrNm»sEmployNm»sBranchCD", 
                                                "sTransNox = " + SQLUtil.toSQL((String) getMaster("sTransNox")));
                    if (lsSQL.isEmpty()){
                        psMessage = "No record to update.";
                        return false;
                    }
                    if (poGRider.executeQuery(lsSQL, MASTER_TABLE, psBranchCd, lsgetBranchCd) <= 0){
                        psMessage = "UPDATE JO MASTER: " + poGRider.getErrMsg();
                        if (!pbWithParent) poGRider.rollbackTrans();
                        return false;
                    }
                }
                lbisModified = false;
                
                
                /*JO LABOR*/
                String lsfTransNox = "";
                int lnfRow = 0;
                lsSQL = "";
                lnCtr = 1;
                
                if (deletedLaborRows != null && !deletedLaborRows.isEmpty()) {
                    pnDeletedLaborRow = deletedLaborRows.toArray(new Integer[deletedLaborRows.size()]);
                }
                
//                if (pnDeletedLaborRow != null && pnDeletedLaborRow.length != 0) {
//                    Arrays.sort(pnDeletedLaborRow, Collections.reverseOrder());
//                    poLaborOrig.beforeFirst();
//                    for (int rowNum : pnDeletedLaborRow) {
//                        poLaborOrig.absolute(rowNum);
//                        lsSQL = "DELETE FROM "+LABOR_TABLE+" WHERE"
//                                + " sLaborCde = " + SQLUtil.toSQL(poLaborOrig.getString("sLaborCde"))
//                                + " AND sTransNox = " + SQLUtil.toSQL((String) getMaster("sTransNox"))
//                                + " AND nEntryNox = " + SQLUtil.toSQL(poLaborOrig.getString("nEntryNox"));
//                        if (poGRider.executeQuery(lsSQL, LABOR_TABLE, psBranchCd, lsgetBranchCd) <= 0) {
//                            psMessage = "DELETE JO LABOR: " + poGRider.getErrMsg() + "; " + poGRider.getMessage();
//                            return false;
//                        }
//                    }
//                }
                
//                if (getLaborCount() > 0){
//                    poLabor.beforeFirst();                
//                    while (poLabor.next()){  
//                        lsfTransNox = poLabor.getString("sTransNox"); 
//                        lnfRow = poLabor.getInt("nEntryNox");
//                        
//                        if (lsfTransNox.isEmpty()){ //ADD
//                            poLabor.updateObject("sTransNox", (String) getMaster("sTransNox")); 
//                            poLabor.updateObject("nEntryNox", lnCtr);
//                            poLabor.updateRow();
//
//                            lsSQL = MiscUtil.rowset2SQL(poLabor, LABOR_TABLE, "");
//                        } else { // UPDATE
//                            poLabor.updateObject("nEntryNox", lnCtr);
//                            poLabor.updateRow();
//
//                            lsSQL = MiscUtil.rowset2SQL(poLabor, 
//                                                        LABOR_TABLE, 
//                                                        "", 
//                                                        " sTransNox = " + SQLUtil.toSQL((String) getMaster("sTransNox")) + 
//                                                        " AND nEntryNox = " + SQLUtil.toSQL(lnfRow)+
//                                                        " AND sLaborCde = " + SQLUtil.toSQL(poLabor.getString("sLaborCde")));
//                        }
//                        
//                        if (lsSQL.isEmpty()){
//                            psMessage = "No record to update in vsp labor.";
//                            return false;
//                        }
//                        if (poGRider.executeQuery(lsSQL, LABOR_TABLE, psBranchCd, lsgetBranchCd) <= 0){
//                            if (!pbWithParent) poGRider.rollbackTrans();
//                            psMessage = "UPDATE VSP LABOR: " +poGRider.getMessage() + " ; " + poGRider.getErrMsg();
//                            return false;
//                        }
//                        lnCtr++;
//                    }
//                }
                
                /*JO PARTS*/
                lsSQL = "";
                lnCtr = 1;
                lnfRow = 0;
                
                if (deletedPartsRows != null && !deletedPartsRows.isEmpty()) {
                    pnDeletedPartsRow = deletedPartsRows.toArray(new Integer[deletedPartsRows.size()]);
                }
                
//                if (pnDeletedPartsRow != null && pnDeletedPartsRow.length != 0) {
//                    Arrays.sort(pnDeletedPartsRow, Collections.reverseOrder());
//                    poPartsOrig.beforeFirst();
//                    for (int rowNum : pnDeletedPartsRow) {
//                        poPartsOrig.absolute(rowNum);
//                        lsSQL = "DELETE FROM "+PARTS_TABLE+" WHERE"
//                                + " sStockIDx = " + SQLUtil.toSQL(poPartsOrig.getString("sStockIDx"))
//                                + " AND sTransNox = " + SQLUtil.toSQL((String) getMaster("sTransNox"))
//                                + " AND nEntryNox = " + SQLUtil.toSQL(poPartsOrig.getString("nEntryNox"));
//                        
//                        if (poGRider.executeQuery(lsSQL, PARTS_TABLE, psBranchCd, lsgetBranchCd) <= 0) {
//                            psMessage = "DELETE JO PARTS: " + poGRider.getErrMsg() + "; " + poGRider.getMessage();
//                            return false;
//                        }
//                    }
//                }
                
//                if (getPartsCount() > 0){
//                    poParts.beforeFirst();                
//                    while (poParts.next()){  
//                        lsfTransNox = poParts.getString("sTransNox"); 
//                        lnfRow = poParts.getInt("nEntryNox");
//                        
//                        if (lsfTransNox.isEmpty()){ //ADD
//                            poParts.updateObject("sTransNox", (String) getMaster("sTransNox")); 
//                            poParts.updateObject("nEntryNox", lnCtr);
//                            poParts.updateRow();
//
//                            lsSQL = MiscUtil.rowset2SQL(poParts, PARTS_TABLE, "sBarCodex»sJobNoxxx");
//                        } else { // UPDATE
//                            poParts.updateObject("nEntryNox", lnCtr);
//                            poParts.updateRow();
//
//                            lsSQL = MiscUtil.rowset2SQL(poParts, 
//                                                        PARTS_TABLE, 
//                                                        "sBarCodex»sJobNoxxx", 
//                                                        " sTransNox = " + SQLUtil.toSQL((String) getMaster("sTransNox")) + 
//                                                        " AND sStockIDx = " + SQLUtil.toSQL(poParts.getString("sStockIDx")) +
//                                                        " AND nEntryNox = " + SQLUtil.toSQL(lnfRow));
//                        }
//                        if (lsSQL.isEmpty()){
//                            psMessage = "No record to update in JO parts.";
//                            return false;
//                        }
//                        if (poGRider.executeQuery(lsSQL, PARTS_TABLE, psBranchCd, lsgetBranchCd) <= 0){
//                            if (!pbWithParent) poGRider.rollbackTrans();
//                            psMessage = "UPDATE JO PARTS: " + poGRider.getMessage() + " ; " + poGRider.getErrMsg();
//                            return false;
//                        }
//                        lnCtr++;
//                    }
//                }
//                
//                if (poLabor != null){
//                    poLaborOrig = (CachedRowSet) poLabor.createCopy();
//                    deletedLaborRows.clear();
//                }
//                if (poParts != null){
//                    poPartsOrig = (CachedRowSet) poParts.createCopy();
//                    deletedPartsRows.clear();
//                }
                
//                if (poMaster != null){
//                    poMasterOrig = (CachedRowSet) poMaster.createCopy();
//                }
                
//                pnDeletedLaborRow = null;
//                deletedLaborRows.clear();
//                pnDeletedPartsRow = null;
//                deletedPartsRows.clear();
            }
            if (!pbWithParent) poGRider.commitTrans();
        } catch (SQLException e) {
            psMessage = e.getMessage();
            return false;
        }
        
        pnEditMode = EditMode.UNKNOWN;
        
        return true;
    }
    
    /**
     * Validate data before saving.
     * 
    */
    private boolean isEntryOK() throws SQLException{
        poMaster.first();
        
        if (poMaster.getString("sDSNoxxxx").isEmpty()){
            psMessage = "JO Number is not set.";
            return false;
        }

        if (poMaster.getString("sSourceNo").isEmpty()){
            psMessage = "Source Intake is not set."; //TODO
            return false;
        }

        if (poMaster.getString("sClientID").isEmpty()){
            psMessage = "Customer is not set.";
            return false;
        }
        
//        if (poMaster.getDouble("nTranTotl") < 0.00){
//            psMessage = "Invalid Gross Amount Total.";
//            return false;
//        }
//        
//        if (poMaster.getDouble("nNetTTotl") < 0.00){
//            psMessage = "Invalid Net Amount Due.";
//            return false;
//        }
        
                
        return true;
    }
    
    private String getSQ_Master(){
        return  " SELECT        " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                " IFNULL(a.sTransNox,'') AS sTransNox " +  //1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                ", a.dTransact  " +  //2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                ", IFNULL(a.sDSNoxxxx,'') AS sDSNoxxxx " +  //3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                ", IFNULL(a.sSerialID,'') AS sSerialID " +  //4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                ", IFNULL(a.sClientID,'') AS sClientID " +  //5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                ", IFNULL(a.sWorkCtgy,'') AS sWorkCtgy " +  //6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                ", IFNULL(a.sJobTypex,'') AS sJobTypex " +  //7                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                ", IFNULL(a.sLaborTyp,'') AS sLaborTyp " +  //8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                ", a.nKMReadng  " +  //9                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                ", IFNULL(a.sEmployID,'') AS sEmployID " +  //10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.sRemarksx,'') AS sRemarksx " +  //11                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.cPaySrcex,'') AS cPaySrcex " +  //12                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.sSourceNo,'') AS sSourceNo " +  //13                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.sSourceCD,'') AS sSourceCD " +  //14                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", a.dPromised  " +  //15                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                ", IFNULL(a.sInsurnce,'') AS sInsurnce " +  //16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.cCompUnit,'') AS cCompUnit " +  //17                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.sActvtyID,'') AS sActvtyID " +  //18                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", a.nLaborAmt  " +  //19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                ", a.nPartsAmt  " +  //20                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                ", a.nTranAmtx  " +  //21                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                ", a.nRcvryAmt  " +  //22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                ", a.nPartFeex  " +  //23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                ", IFNULL(a.cPrintedx,'') AS cPrintedx " +  //24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.cTranStat,'') AS cTranStat " +  //25                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", IFNULL(a.sEntryByx,'') AS sEntryByx " +  //26                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                ", a.dEntryDte  " +  //27                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                ", IFNULL(a.sModified,'') AS sModified " +  //28                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                ", a.dModified  " +  //29                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                " , CASE WHEN a.cTranStat = '0' THEN 'Y' ELSE 'N' END AS cTrStatus " + //30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                 /*a.dTimeStmp, */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                ", IFNULL(b.sCompnyNm,'') AS sCompnyNm  " +   /*customer name*/  //31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                ", IFNULL(CONCAT( IFNULL(CONCAT(c.sAddressx,', ') , ''),  " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            " IFNULL(CONCAT(e.sBrgyName,', '), ''),       " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            " IFNULL(CONCAT(d.sTownName, ', '),''),       " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            " IFNULL(CONCAT(f.sProvName),'') )	, '') AS sAddressx " +    /*customer address*/ //32                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                ", IFNULL(j.sCompnyNm,'') AS sCoOwnrNm  " +    /*co-owner*/   //33                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                ", IFNULL(l.sCompnyNm,'') AS sCoBuyrNm  " +    /*co-buyer*/   //34                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                ", IFNULL(i.sDescript,'') AS sDescript  " +   //35                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                ", IFNULL(g.sCSNoxxxx,'') AS sCSNoxxxx  " +   //36                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                ", IFNULL(h.sPlateNox,'') AS sPlateNox  " +   //37                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                ", IFNULL(g.sFrameNox,'') AS sFrameNox  " +   //38                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                ", IFNULL(g.sEngineNo,'') AS sEngineNo  " +   //39     
                ", IFNULL(m.sCompnyNm,'') AS sEmployNm  " +    /*SE / SA NAME*/    //40   
                ", IFNULL(k.sBranchCD,'') AS sBranchCD  " +    /*VSP BRANCH CODE*/ //41
                " FROM diagnostic_master a    " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                " LEFT JOIN client_master b ON b.sClientID = a.sClientID  " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                " LEFT JOIN client_address c ON c.sClientID = b.sClientID AND c.cPrimaryx = '1'  " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                " LEFT JOIN TownCity d ON d.sTownIDxx = c.sTownIDxx  " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                " LEFT JOIN barangay e ON e.sBrgyIDxx = c.sBrgyIDxx AND e.sTownIDxx = c.sTownIDxx " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                " LEFT JOIN Province f ON f.sProvIDxx = d.sProvIDxx   " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                " LEFT JOIN vehicle_serial g ON g.sSerialID = a.sSerialID " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                " LEFT JOIN vehicle_serial_registration h ON h.sSerialID = g.sSerialID    " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                " LEFT JOIN vehicle_master i ON i.sVhclIDxx = g.sVhclIDxx    " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                " LEFT JOIN client_master j ON j.sClientID = g.sCoCltIDx " + /*co-owner*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                " LEFT JOIN vsp_master k ON k.sTransNox = a.sSourceCD    " +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                " LEFT JOIN client_master l ON l.sClientID = k.sCoCltIDx " + /*co-buyer*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                " LEFT JOIN ggc_isysdbf.client_master m ON m.sClientID = a.sEmployID "   ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
         
    }
    
    private String getSQ_searchVSP(){
        return  " SELECT  " +                                                                            
                " IFNULL(a.sTransNox, '') AS sTransNox   " +                                             
                " ,a.dTransact  " +                                                                      
                " ,IFNULL(a.sVSPNOxxx, '') AS sVSPNOxxx  " +                                             
                " ,IFNULL(a.sClientID, '') AS sClientID  " +                                             
                " ,IFNULL(a.sSerialID, '') AS sSerialID  " +                                             
                " ,IFNULL(a.sBranchCD, '') AS sBranchCD  " +                                             
                " ,a.cTranStat " +                                                                       
                " , IFNULL(c.sCompnyNm,'') AS sCompnyNm  " +                                             
                " , IFNULL(CONCAT( IFNULL(CONCAT(h.sAddressx,', ') , ''), " +                            
                "       IFNULL(CONCAT(j.sBrgyName,', '), ''),  " +                                             
                "       IFNULL(CONCAT(i.sTownName, ', '),''),  " +                                             
                "       IFNULL(CONCAT(k.sProvName),'') )	, '') AS sAddressx    " +                            
                " , IFNULL(f.sDescript,'') AS sDescript  " + 																							
                " , IFNULL(d.sCSNoxxxx,'') AS sCSNoxxxx  " + 																							
                " , IFNULL(e.sPlateNox,'') AS sPlateNox  " + 																							
                " , IFNULL(d.sFrameNox,'') AS sFrameNox  " + 																							
                " , IFNULL(d.sEngineNo,'') AS sEngineNo  " +                                             
                " , IFNULL(g.sCompnyNm, '') AS sSalesExe " +                                             
                " , CASE WHEN a.cTranStat = '0' THEN 'Y' ELSE 'N' END AS cTrStatus   " +                 
                " , IFNULL(a.sCoCltIDx,'') AS sCoCltIDx  " +                                             
                " , IFNULL(l.sCompnyNm,'') AS sCoBuyrNm  " +                                             
                " FROM vsp_master a     " +                                                              
                " LEFT JOIN customer_inquiry b ON b.sTransNox = a.sInqryIDx " +                          
                " LEFT JOIN client_master c ON c.sClientID = a.sClientID  	" +														
                " LEFT JOIN vehicle_serial d ON d.sSerialID = a.sSerialID   " +														
                " LEFT JOIN vehicle_serial_registration e ON e.sSerialID = d.sSerialID  " +              
                " LEFT JOIN vehicle_master f ON f.sVhclIDxx = d.sVhclIDxx   " +                          
                " LEFT JOIN ggc_isysdbf.client_master g ON g.sClientID = b.sEmployID  " +                
                " LEFT JOIN client_address h ON h.sClientID = c.sClientID AND h.cPrimaryx = '1'    " +   
                " LEFT JOIN TownCity i on i.sTownIDxx = h.sTownIDxx    " +                               
                " LEFT JOIN barangay j ON j.sBrgyIDxx = h.sBrgyIDxx and j.sTownIDxx = h.sTownIDxx  " +   
                " LEFT JOIN Province k ON k.sProvIDxx = i.sProvIDxx   " ;                              
 
    }
    
    public boolean searchVSP(String fsValue) throws SQLException{
        String lsSQL = getSQ_searchVSP();
        lsSQL = lsSQL + " WHERE a.sVSPNOxxx LIKE " + SQLUtil.toSQL(fsValue + "%") +
                        " AND (a.sSerialID <> NULL OR a.sSerialID <> '') " +
                        " AND a.cTranStat = '1'  "  +
                        " GROUP BY a.sTransNox " ;
        System.out.println(lsSQL);
        ResultSet loRS;
        JSONObject loJSON = null;
        if (!pbWithUI) {   
            lsSQL += " LIMIT 1";
            loRS = poGRider.executeQuery(lsSQL);
            
            if (loRS.next()){
                setMaster("sVSPNOxxx", loRS.getString("sVSPNOxxx"));
                setMaster("sCompnyNm", loRS.getString("sCompnyNm"));
                setMaster("sAddressx", loRS.getString("sAddressx"));
                setMaster("sDescript", loRS.getString("sDescript"));
                setMaster("sCSNoxxxx", loRS.getString("sCSNoxxxx"));
                setMaster("sPlateNox", loRS.getString("sPlateNox"));
                setMaster("sFrameNox", loRS.getString("sFrameNox"));
                setMaster("sEngineNo", loRS.getString("sEngineNo"));
                setMaster("sClientID", loRS.getString("sClientID"));
                setMaster("sSerialID", loRS.getString("sSerialID"));
                setMaster("sSourceCD", loRS.getString("sTransNox"));
                setMaster("sSourceNo", loRS.getString("sVSPNOxxx")); 
                setMaster("sCoCltIDx", loRS.getString("sCoCltIDx"));
                setMaster("sCoCltNmx", loRS.getString("sCoBuyrNm"));  
           
            } else {
                psMessage = "No record found.";
                setMaster("sVSPNOxxx", "");
                setMaster("sCompnyNm", "");
                setMaster("sAddressx", "");
                setMaster("sDescript", "");
                setMaster("sCSNoxxxx", "");
                setMaster("sPlateNox", "");
                setMaster("sFrameNox", "");
                setMaster("sEngineNo", "");
                setMaster("sClientID", "");
                setMaster("sSerialID", "");
                setMaster("sSourceCD", "");
                setMaster("sSourceNo", "");
                setMaster("sCoCltIDx", "");
                setMaster("sCoBuyrNm", "");  
                return false;
            }           
        } else {
            loJSON = showFXDialog.jsonSearch(poGRider, 
                                             lsSQL,
                                             "%" + fsValue +"%",
                                             "VSP No»Customer Name»CS NO»Plate no", 
                                             "sVSPNOxxx»sCompnyNm»sCSNoxxxx»sPlateNox",
                                             "sVSPNOxxx»sCompnyNm»sCSNoxxxx»sPlateNox",
                                             0);
            
            if (loJSON != null){
                setMaster("sVSPNOxxx", (String) loJSON.get("sVSPNOxxx"));
                setMaster("sCompnyNm", (String) loJSON.get("sCompnyNm"));
                setMaster("sAddressx", (String) loJSON.get("sAddressx"));
                setMaster("sDescript", (String) loJSON.get("sDescript"));
                setMaster("sCSNoxxxx", (String) loJSON.get("sCSNoxxxx"));
                setMaster("sPlateNox", (String) loJSON.get("sPlateNox"));
                setMaster("sFrameNox", (String) loJSON.get("sFrameNox"));
                setMaster("sEngineNo", (String) loJSON.get("sEngineNo"));
                setMaster("sClientID", (String) loJSON.get("sClientID"));
                setMaster("sSerialID", (String) loJSON.get("sSerialID"));
                setMaster("sSourceCD", (String) loJSON.get("sTransNox"));
                setMaster("sSourceNo", (String) loJSON.get("sVSPNOxxx"));
                setMaster("sCoCltIDx", (String) loJSON.get("sCoCltIDx"));
                setMaster("sCoCltNmx", (String) loJSON.get("sCoBuyrNm"));   
            } else {
                psMessage = "No record found/selected.";
                setMaster("sVSPNOxxx", "");
                setMaster("sCompnyNm", "");
                setMaster("sAddressx", "");
                setMaster("sDescript", "");
                setMaster("sCSNoxxxx", "");
                setMaster("sPlateNox", "");
                setMaster("sFrameNox", "");
                setMaster("sEngineNo", "");
                setMaster("sClientID", "");
                setMaster("sSerialID", "");
                setMaster("sSourceCD", "");
                setMaster("sSourceNo", "");
                setMaster("sCoCltIDx", "");
                setMaster("sCoBuyrNm", "");  
                return false;    
            }
        } 
        return true;
    }
    
    public boolean loadVSPLabor(){
    
        return true;
    }
    
    public boolean loadVSPParts(){
    
        return true;
    }
    
    //TODO
    public boolean searchIntake(String fsValue) throws SQLException{
//        String lsSQL = getSQ_searchVSP();
//        lsSQL = lsSQL + " WHERE a.sVSPNOxxx LIKE " + SQLUtil.toSQL(fsValue + "%") +
//                        " AND (a.sSerialID <> NULL OR a.sSerialID <> '') " +
//                        " AND a.cTranStat = '1'  "  +
//                        " GROUP BY a.sTransNox " ;
//        System.out.println(lsSQL);
//        ResultSet loRS;
//        JSONObject loJSON = null;
//        if (!pbWithUI) {   
//            lsSQL += " LIMIT 1";
//            loRS = poGRider.executeQuery(lsSQL);
//            
//            if (loRS.next()){
//                setMaster("sVSPNOxxx", loRS.getString("sVSPNOxxx"));
//                setMaster("sCompnyNm", loRS.getString("sCompnyNm"));
//                setMaster("sAddressx", loRS.getString("sAddressx"));
//                setMaster("sDescript", loRS.getString("sDescript"));
//                setMaster("sCSNoxxxx", loRS.getString("sCSNoxxxx"));
//                setMaster("sPlateNox", loRS.getString("sPlateNox"));
//                setMaster("sFrameNox", loRS.getString("sFrameNox"));
//                setMaster("sEngineNo", loRS.getString("sEngineNo"));
//                setMaster("sClientID", loRS.getString("sClientID"));
//                setMaster("sSerialID", loRS.getString("sSerialID"));
//                setMaster("sSourceCD", loRS.getString("sTransNox"));
//                setMaster("sSourceNo", loRS.getString("sVSPNOxxx")); 
//                setMaster("sCoCltIDx", loRS.getString("sCoCltIDx"));
//                setMaster("sCoCltNmx", loRS.getString("sCoBuyrNm"));  
//           
//            } else {
//                psMessage = "No record found.";
//                setMaster("sVSPNOxxx", "");
//                setMaster("sCompnyNm", "");
//                setMaster("sAddressx", "");
//                setMaster("sDescript", "");
//                setMaster("sCSNoxxxx", "");
//                setMaster("sPlateNox", "");
//                setMaster("sFrameNox", "");
//                setMaster("sEngineNo", "");
//                setMaster("sClientID", "");
//                setMaster("sSerialID", "");
//                setMaster("sSourceCD", "");
//                setMaster("sSourceNo", "");
//                setMaster("sCoCltIDx", "");
//                setMaster("sCoBuyrNm", "");  
//                return false;
//            }           
//        } else {
//            loJSON = showFXDialog.jsonSearch(poGRider, 
//                                             lsSQL,
//                                             "%" + fsValue +"%",
//                                             "VSP No»Customer Name»CS NO»Plate no", 
//                                             "sVSPNOxxx»sCompnyNm»sCSNoxxxx»sPlateNox",
//                                             "sVSPNOxxx»sCompnyNm»sCSNoxxxx»sPlateNox",
//                                             0);
//            
//            if (loJSON != null){
//                setMaster("sVSPNOxxx", (String) loJSON.get("sVSPNOxxx"));
//                setMaster("sCompnyNm", (String) loJSON.get("sCompnyNm"));
//                setMaster("sAddressx", (String) loJSON.get("sAddressx"));
//                setMaster("sDescript", (String) loJSON.get("sDescript"));
//                setMaster("sCSNoxxxx", (String) loJSON.get("sCSNoxxxx"));
//                setMaster("sPlateNox", (String) loJSON.get("sPlateNox"));
//                setMaster("sFrameNox", (String) loJSON.get("sFrameNox"));
//                setMaster("sEngineNo", (String) loJSON.get("sEngineNo"));
//                setMaster("sClientID", (String) loJSON.get("sClientID"));
//                setMaster("sSerialID", (String) loJSON.get("sSerialID"));
//                setMaster("sSourceCD", (String) loJSON.get("sTransNox"));
//                setMaster("sSourceNo", (String) loJSON.get("sVSPNOxxx"));
//                setMaster("sCoCltIDx", (String) loJSON.get("sCoCltIDx"));
//                setMaster("sCoCltNmx", (String) loJSON.get("sCoBuyrNm"));   
//            } else {
//                psMessage = "No record found/selected.";
//                setMaster("sVSPNOxxx", "");
//                setMaster("sCompnyNm", "");
//                setMaster("sAddressx", "");
//                setMaster("sDescript", "");
//                setMaster("sCSNoxxxx", "");
//                setMaster("sPlateNox", "");
//                setMaster("sFrameNox", "");
//                setMaster("sEngineNo", "");
//                setMaster("sClientID", "");
//                setMaster("sSerialID", "");
//                setMaster("sSourceCD", "");
//                setMaster("sSourceNo", "");
//                setMaster("sCoCltIDx", "");
//                setMaster("sCoBuyrNm", "");  
//                return false;    
//            }
//        } 
        return true;
    }
    
    
    private void displayMasFields() throws SQLException{
        if (pnEditMode != EditMode.ADDNEW && pnEditMode != EditMode.UPDATE) return;
        
        int lnRow = poMaster.getMetaData().getColumnCount();
        
        System.out.println("----------------------------------------");
        System.out.println("MASTER TABLE INFO");
        System.out.println("----------------------------------------");
        System.out.println("Total number of columns: " + lnRow);
        System.out.println("----------------------------------------");
        
        for (int lnCtr = 1; lnCtr <= lnRow; lnCtr++){
            System.out.println("Column index: " + (lnCtr) + " --> Label: " + poMaster.getMetaData().getColumnLabel(lnCtr));
            System.out.println("Column type: " + (lnCtr) + " --> " + poMaster.getMetaData().getColumnType(lnCtr));
            if (poMaster.getMetaData().getColumnType(lnCtr) == Types.CHAR ||
                poMaster.getMetaData().getColumnType(lnCtr) == Types.VARCHAR){
                
                System.out.println("Column index: " + (lnCtr) + " --> Size: " + poMaster.getMetaData().getColumnDisplaySize(lnCtr));
            }
        }
        
        System.out.println("----------------------------------------");
        System.out.println("END: MASTER TABLE INFO");
        System.out.println("----------------------------------------");
    } 
}
